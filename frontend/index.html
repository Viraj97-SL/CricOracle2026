<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CricOracle 2026 â€” T20 World Cup Predictor</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --surface2: #21262d;
    --border: #30363d; --text: #e6edf3; --muted: #8b949e;
    --green: #3fb950; --blue: #58a6ff; --orange: #f0883e;
    --red: #f85149; --purple: #bc8cff; --yellow: #d29922;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; min-height: 100vh; }

  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.9rem 2rem; display: flex; align-items: center; gap: 1rem; }
  header h1 { font-size: 1.3rem; color: var(--blue); font-weight: 700; }
  header .badge { background: var(--green); color: #000; font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; font-weight: 700; letter-spacing: 0.05em; }
  .header-meta { margin-left: auto; color: var(--muted); font-size: 0.78rem; }

  .tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--surface); padding: 0 1rem; }
  .tab { padding: 0.75rem 1.2rem; cursor: pointer; border-bottom: 2px solid transparent; color: var(--muted); font-size: 0.88rem; transition: all 0.2s; user-select: none; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--blue); border-bottom-color: var(--blue); }

  .container { max-width: 980px; margin: 0 auto; padding: 1.5rem 1rem; }
  .panel { display: none; }
  .panel.active { display: block; }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; margin-bottom: 1.25rem; }
  .card-title { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 0.9rem; font-weight: 600; }

  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  @media (max-width: 640px) { .grid2 { grid-template-columns: 1fr; } }

  label { display: block; font-size: 0.78rem; color: var(--muted); margin-bottom: 0.3rem; margin-top: 0.7rem; }
  select, input[type="text"] { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 0.55rem 0.75rem; border-radius: 6px; font-size: 0.88rem; }
  select:focus, input:focus { outline: none; border-color: var(--blue); }

  button.primary { background: var(--blue); color: #000; border: none; padding: 0.7rem 2rem; border-radius: 6px; font-size: 0.88rem; font-weight: 700; cursor: pointer; width: 100%; margin-top: 1rem; transition: opacity 0.2s; }
  button.primary:hover { opacity: 0.85; }
  button.primary:disabled { opacity: 0.35; cursor: not-allowed; }

  /* â”€â”€ XI selection panel â”€â”€ */
  .xi-panel { display: none; margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem; }
  .xi-panel.visible { display: block; }
  .xi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem; }
  .xi-title { font-size: 0.8rem; color: var(--text); font-weight: 600; }
  .xi-count { font-size: 0.75rem; padding: 2px 10px; border-radius: 10px; font-weight: 700; }
  .xi-count.ok { background: #1a4a1a; color: var(--green); }
  .xi-count.partial { background: #3d2e00; color: var(--orange); }
  .xi-count.empty { background: var(--surface2); color: var(--muted); }

  .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(148px, 1fr)); gap: 0.45rem; }
  .player-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem 0.6rem; cursor: pointer; transition: all 0.15s; position: relative; user-select: none; }
  .player-card:hover:not(.injured) { border-color: var(--blue); }
  .player-card.selected { border-color: var(--green); background: #0d2a0d; }
  .player-card.injured { opacity: 0.42; cursor: not-allowed; }
  .player-card .p-name { font-size: 0.82rem; font-weight: 600; line-height: 1.2; padding-right: 18px; }
  .player-card .p-meta { font-size: 0.68rem; color: var(--muted); margin-top: 0.25rem; display: flex; gap: 0.35rem; flex-wrap: wrap; }
  .player-card .p-check { position: absolute; top: 6px; right: 7px; font-size: 0.75rem; color: var(--green); opacity: 0; }
  .player-card.selected .p-check { opacity: 1; }
  .role-badge { font-size: 0.62rem; padding: 1px 5px; border-radius: 3px; font-weight: 600; }
  .role-bat   { background: #0d2a4a; color: var(--blue); }
  .role-bowl  { background: #3d1a1a; color: var(--red); }
  .role-all   { background: #1a2a0a; color: var(--green); }
  .icon-cap { color: var(--yellow); font-size: 0.65rem; }
  .icon-wk  { color: var(--purple); font-size: 0.65rem; }
  .icon-inj { color: var(--red); font-size: 0.65rem; }
  .xi-loading { color: var(--muted); font-size: 0.8rem; padding: 0.5rem 0; }

  /* â”€â”€ Results â”€â”€ */
  .result-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-top: 1.25rem; display: none; }
  .result-card.show { display: block; }
  .team-row { display: flex; justify-content: space-between; align-items: center; padding: 0.65rem 0; border-bottom: 1px solid var(--border); }
  .team-row:last-child { border-bottom: none; }
  .team-name { font-size: 1.05rem; font-weight: 600; }
  .prob-bar-wrap { flex: 1; margin: 0 1rem; }
  .prob-bar { height: 7px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .prob-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
  .prob-fill.t1 { background: var(--blue); }
  .prob-fill.t2 { background: var(--orange); }
  .prob-pct { font-size: 1.15rem; font-weight: 700; min-width: 52px; text-align: right; }
  .score-sub { font-size: 0.7rem; color: var(--muted); margin-top: 3px; }

  .result-badges { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.75rem; flex-wrap: wrap; }
  .confidence { display: inline-block; padding: 2px 10px; border-radius: 10px; font-size: 0.72rem; font-weight: 700; }
  .conf-High { background: #1a4a1a; color: var(--green); }
  .conf-Medium { background: #3d2e00; color: var(--orange); }
  .conf-Low { background: #3d1a1a; color: var(--red); }
  .xi-badge { display: inline-block; padding: 2px 10px; border-radius: 10px; font-size: 0.72rem; font-weight: 700; background: #1a1a4a; color: var(--purple); }

  .factors { margin-top: 0.75rem; }
  .factors-title { font-size: 0.72rem; color: var(--muted); margin-bottom: 0.35rem; text-transform: uppercase; letter-spacing: 0.06em; }
  .factor { display: flex; align-items: flex-start; gap: 0.4rem; padding: 0.3rem 0; font-size: 0.82rem; line-height: 1.3; }
  .factor .icon::before { font-size: 0.7rem; }
  .factor.pos .icon::before { content: 'â–²'; color: var(--green); }
  .factor.neg .icon::before { content: 'â–¼'; color: var(--red); }

  .score-big { font-size: 2.2rem; font-weight: 700; color: var(--green); }
  .score-range { font-size: 0.78rem; color: var(--muted); }

  /* â”€â”€ Spinner / Error â”€â”€ */
  .spinner { display: none; width: 22px; height: 22px; border: 2px solid var(--border); border-top-color: var(--blue); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 1.2rem auto; }
  .spinner.show { display: block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error-box { background: #2d1a1a; border: 1px solid var(--red); color: var(--red); padding: 0.7rem 1rem; border-radius: 6px; font-size: 0.82rem; margin-top: 0.75rem; display: none; }
  .error-box.show { display: block; }

  /* â”€â”€ Squad browser tab â”€â”€ */
  .squad-browser { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
  .squad-team-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; }
  .squad-team-name { font-weight: 700; font-size: 1rem; color: var(--blue); margin-bottom: 0.2rem; }
  .squad-captain { font-size: 0.75rem; color: var(--muted); margin-bottom: 0.75rem; }
  .squad-player-row { font-size: 0.8rem; padding: 0.2rem 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
  .squad-player-row:last-child { border-bottom: none; }
  .squad-player-name { font-weight: 500; }
  .squad-player-meta { display: flex; gap: 0.4rem; align-items: center; color: var(--muted); font-size: 0.72rem; }

  /* â”€â”€ Squad optimiser â”€â”€ */
  .squad-list { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.6rem; }
  .player-tag { background: var(--surface2); border: 1px solid var(--border); padding: 0.35rem 0.6rem; border-radius: 6px; font-size: 0.82rem; display: flex; align-items: center; gap: 0.4rem; }
  .player-tag .rm { color: var(--red); font-size: 0.7rem; cursor: pointer; }
  .xi-chip { background: #0d2a0d; border: 1px solid var(--green); padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.78rem; color: var(--green); }

  .footer { text-align: center; padding: 2rem; color: var(--muted); font-size: 0.72rem; border-top: 1px solid var(--border); margin-top: 1rem; }
</style>
</head>
<body>

<header>
  <span style="font-size:1.4rem">ğŸ</span>
  <h1>CricOracle 2026</h1>
  <span class="badge">LIVE</span>
  <span class="header-meta">T20 World Cup Predictor Â· XGBoost AUC 0.897</span>
</header>

<div class="tabs">
  <div class="tab active" onclick="switchTab('match')">Match Outcome</div>
  <div class="tab" onclick="switchTab('score')">Score Predictor</div>
  <div class="tab" onclick="switchTab('squads')">WC 2026 Squads</div>
  <div class="tab" onclick="switchTab('optim')">XI Optimiser</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MATCH TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-match" class="panel active">
<div class="container">
  <div class="card">
    <div class="card-title">Match Setup</div>
    <div class="grid2">
      <div>
        <label>Team 1 (batting first)</label>
        <select id="m-team1" onchange="teamChanged('team1')"><option value="">Select teamâ€¦</option></select>
      </div>
      <div>
        <label>Team 2</label>
        <select id="m-team2" onchange="teamChanged('team2')"><option value="">Select teamâ€¦</option></select>
      </div>
    </div>
    <label>Venue</label>
    <select id="m-venue"><option value="">Select venueâ€¦</option></select>
    <div class="grid2">
      <div>
        <label>Toss Winner <span style="color:var(--muted)">(optional)</span></label>
        <select id="m-toss-winner"><option value="">Unknown</option></select>
      </div>
      <div>
        <label>Toss Decision <span style="color:var(--muted)">(optional)</span></label>
        <select id="m-toss-decision">
          <option value="">Unknown</option>
          <option value="bat">Bat</option>
          <option value="field">Field</option>
        </select>
      </div>
    </div>

    <!-- XI Selection panels (shown after team selected) -->
    <div class="xi-panel" id="xi-panel-team1">
      <div class="xi-header">
        <span class="xi-title" id="xi-title-team1">Team 1 Playing XI</span>
        <span class="xi-count empty" id="xi-count-team1">0 / 11</span>
      </div>
      <div id="xi-grid-team1" class="player-grid"><span class="xi-loading">Loading squadâ€¦</span></div>
    </div>

    <div class="xi-panel" id="xi-panel-team2">
      <div class="xi-header">
        <span class="xi-title" id="xi-title-team2">Team 2 Playing XI</span>
        <span class="xi-count empty" id="xi-count-team2">0 / 11</span>
      </div>
      <div id="xi-grid-team2" class="player-grid"><span class="xi-loading">Loading squadâ€¦</span></div>
    </div>

    <div id="xi-info" style="font-size:0.75rem;color:var(--muted);margin-top:0.75rem;display:none">
      Selecting exactly 11 players enables XI-enhanced prediction using individual player batting/bowling profiles.
    </div>

    <button class="primary" onclick="predictMatch()" id="m-predict-btn">Predict Match</button>
  </div>

  <div class="spinner" id="m-spinner"></div>
  <div class="error-box" id="m-error"></div>

  <div class="result-card" id="m-result">
    <div class="result-badges">
      <span class="confidence" id="m-conf">Medium</span>
      <span class="xi-badge" id="m-xi-badge" style="display:none">XI-Enhanced Prediction</span>
    </div>
    <div class="team-row">
      <div>
        <div class="team-name" id="m-t1-name">Team 1</div>
        <div class="score-sub" id="m-score1"></div>
      </div>
      <div class="prob-bar-wrap">
        <div class="prob-bar"><div class="prob-fill t1" id="m-t1-bar" style="width:50%"></div></div>
      </div>
      <span class="prob-pct" id="m-t1-pct" style="color:var(--blue)">50%</span>
    </div>
    <div class="team-row">
      <div>
        <div class="team-name" id="m-t2-name">Team 2</div>
        <div class="score-sub" id="m-score2"></div>
      </div>
      <div class="prob-bar-wrap">
        <div class="prob-bar"><div class="prob-fill t2" id="m-t2-bar" style="width:50%"></div></div>
      </div>
      <span class="prob-pct" id="m-t2-pct" style="color:var(--orange)">50%</span>
    </div>
    <div class="factors" id="m-factors"></div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCORE TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-score" class="panel">
<div class="container">
  <div class="card">
    <div class="card-title">First Innings Score Predictor</div>
    <div class="grid2">
      <div>
        <label>Batting Team</label>
        <select id="s-batting"><option value="">Select teamâ€¦</option></select>
      </div>
      <div>
        <label>Bowling Team</label>
        <select id="s-bowling"><option value="">Select teamâ€¦</option></select>
      </div>
    </div>
    <label>Venue</label>
    <select id="s-venue"><option value="">Select venueâ€¦</option></select>
    <div class="grid2">
      <div>
        <label>Toss Winner <span style="color:var(--muted)">(optional)</span></label>
        <select id="s-toss-winner"><option value="">Unknown</option></select>
      </div>
      <div>
        <label>Toss Decision <span style="color:var(--muted)">(optional)</span></label>
        <select id="s-toss-decision">
          <option value="">Unknown</option>
          <option value="bat">Bat</option>
          <option value="field">Field</option>
        </select>
      </div>
    </div>
    <button class="primary" onclick="predictScore()">Predict Score</button>
  </div>

  <div class="spinner" id="s-spinner"></div>
  <div class="error-box" id="s-error"></div>

  <div class="result-card" id="s-result">
    <div class="card-title">Predicted First Innings Score</div>
    <div style="margin-top:0.75rem">
      <div style="color:var(--muted);font-size:0.88rem" id="s-team-label"></div>
      <div style="display:flex;align-items:baseline;gap:0.75rem;margin-top:0.4rem">
        <span class="score-big" id="s-score">â€“</span>
        <span class="score-range" id="s-range">â€“</span>
      </div>
    </div>
    <div style="margin-top:0.75rem;font-size:0.78rem;color:var(--muted)" id="s-venue-label"></div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SQUADS TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-squads" class="panel">
<div class="container">
  <div class="card" style="margin-bottom:1rem">
    <div class="card-title">ICC T20 World Cup 2026 â€” Team Squads</div>
    <p style="font-size:0.82rem;color:var(--muted)">Squads based on current T20I form. Update <code>data/squads/wc2026_squads.json</code> as official announcements are made.</p>
  </div>
  <div class="squad-browser" id="squad-browser"><span style="color:var(--muted);font-size:0.85rem">Loading squadsâ€¦</span></div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SQUAD OPTIMISER TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-optim" class="panel">
<div class="container">
  <div class="card">
    <div class="card-title">XI Optimiser (Genetic Algorithm)</div>
    <div class="grid2">
      <div>
        <label>Team Name</label>
        <input type="text" id="sq-team" placeholder="e.g. India" />
      </div>
      <div>
        <label>Venue</label>
        <select id="sq-venue"><option value="">Select venueâ€¦</option></select>
      </div>
    </div>
    <label>Opponent <span style="color:var(--muted)">(optional)</span></label>
    <input type="text" id="sq-opponent" placeholder="e.g. Australia" />
    <label>Squad â€” type player name and press Enter (min 11)</label>
    <input type="text" id="sq-player-input" placeholder="Player nameâ€¦" onkeydown="addPlayer(event)" />
    <div class="squad-list" id="sq-squad-list"></div>
    <div style="margin-top:0.4rem;font-size:0.78rem;color:var(--muted)" id="sq-count">0 players added (need â‰¥11)</div>
    <button class="primary" onclick="optimiseSquad()" id="sq-btn" disabled>Optimise Playing XI</button>
  </div>

  <div class="spinner" id="sq-spinner"></div>
  <div class="error-box" id="sq-error"></div>

  <div class="result-card" id="sq-result">
    <div class="card-title">Selected Playing XI</div>
    <div id="sq-xi" class="squad-list" style="margin-top:0.4rem"></div>
    <div class="card-title" style="margin-top:1rem">Bench</div>
    <div id="sq-bench" class="squad-list" style="margin-top:0.4rem"></div>
    <div style="margin-top:1rem" id="sq-reasoning"></div>
  </div>
</div>
</div>

<div class="footer">
  CricOracle 2026 Â· XGBoost ensemble Â· AUC 0.897 Â· Calibrated probabilities Â·
  <a href="/docs" style="color:var(--blue)">API Docs</a>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Config
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = window.location.origin;   // Same-origin when served via FastAPI /ui
let teams = [], venues = [];
let selectedXI = { team1: [], team2: [] };
let loadedSquads = { team1: [], team2: [] };
let allSquads = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Bootstrap
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  try {
    const [teamsRes, squadsRes] = await Promise.all([
      fetch(`${API}/predict/teams`),
      fetch(`${API}/predict/squads`)
    ]);

    if (teamsRes.ok) {
      const d = await teamsRes.json();
      teams = d.teams;
      venues = d.venues;
      populateSelects();
    }

    if (squadsRes.ok) {
      allSquads = await squadsRes.json();
      renderSquadBrowser();
    }
  } catch(e) {
    console.error('API unavailable:', e);
    document.querySelector('.footer').innerHTML +=
      '<br><span style="color:var(--red)">âš  API offline â€” start with: uvicorn api.main:app --reload --port 8000</span>';
  }
}

function populateSelects() {
  ['m-team1','m-team2','s-batting','s-bowling'].forEach(id => {
    const el = document.getElementById(id);
    el.innerHTML = '<option value="">Select teamâ€¦</option>' +
      teams.map(t => `<option value="${t}">${t}</option>`).join('');
  });
  ['m-venue','s-venue','sq-venue'].forEach(id => {
    const el = document.getElementById(id);
    el.innerHTML = '<option value="">Select venueâ€¦</option>' +
      venues.map(v => `<option value="${v}">${v}</option>`).join('');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// XI Panel logic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function teamChanged(side) {
  const teamVal = document.getElementById(`m-${side === 'team1' ? 'team1' : 'team2'}`).value;
  updateTossOptions();
  updateXIInfo();

  const panelEl = document.getElementById(`xi-panel-${side}`);
  const titleEl = document.getElementById(`xi-title-${side}`);
  const gridEl  = document.getElementById(`xi-grid-${side}`);

  if (!teamVal) {
    panelEl.classList.remove('visible');
    selectedXI[side] = [];
    loadedSquads[side] = [];
    return;
  }

  titleEl.textContent = `${teamVal} â€” Playing XI`;
  panelEl.classList.add('visible');
  gridEl.innerHTML = '<span class="xi-loading">Loading squadâ€¦</span>';
  selectedXI[side] = [];
  updateXICount(side);

  try {
    let squad = [];
    if (allSquads[teamVal] && allSquads[teamVal].squad) {
      squad = allSquads[teamVal].squad;
    } else {
      const r = await fetch(`${API}/predict/squads/${encodeURIComponent(teamVal)}`);
      if (r.ok) {
        const d = await r.json();
        squad = d.squad || [];
      }
    }
    loadedSquads[side] = squad;
    renderXIGrid(side, squad);
  } catch(e) {
    gridEl.innerHTML = `<span class="xi-loading" style="color:var(--red)">Could not load squad for ${teamVal}</span>`;
  }
  updateXIInfo();
}

function renderXIGrid(side, squad) {
  const gridEl = document.getElementById(`xi-grid-${side}`);
  if (!squad || squad.length === 0) {
    gridEl.innerHTML = '<span class="xi-loading">No squad data available</span>';
    return;
  }
  gridEl.innerHTML = squad.map(p => playerCardHTML(side, p)).join('');
}

function playerCardHTML(side, p) {
  const injured = p.injury_status && p.injury_status !== 'fit';
  const roleCls = p.role === 'Batsman' ? 'role-bat' : p.role === 'Bowler' ? 'role-bowl' : 'role-all';
  const roleShort = p.role === 'Batsman' ? 'BAT' : p.role === 'Bowler' ? 'BOWL' : 'AR';
  const escapedName = p.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
  const clickAttr = injured ? '' : `onclick="togglePlayer('${side}', '${escapedName}', this)"`;
  return `<div class="player-card${injured ? ' injured' : ''}" id="pc-${side}-${escapedName.replace(/\s/g,'_')}" ${clickAttr}>
    <div class="p-name">${p.name}</div>
    <div class="p-meta">
      <span class="role-badge ${roleCls}">${roleShort}</span>
      ${p.batting_order ? `<span>${p.batting_order}</span>` : ''}
      ${p.is_captain ? '<span class="icon-cap">â˜… C</span>' : ''}
      ${p.is_keeper ? '<span class="icon-wk">ğŸ§¤ WK</span>' : ''}
      ${injured ? `<span class="icon-inj">âš  ${p.injury_status}</span>` : ''}
      ${p.bowling_style ? `<span style="color:var(--muted)">${p.bowling_style}</span>` : ''}
    </div>
    <span class="p-check">âœ“</span>
  </div>`;
}

function togglePlayer(side, name, card) {
  const idx = selectedXI[side].indexOf(name);
  if (idx >= 0) {
    selectedXI[side].splice(idx, 1);
    card.classList.remove('selected');
  } else {
    if (selectedXI[side].length >= 11) {
      // Deselect first selected player
      const first = selectedXI[side].shift();
      const firstCard = document.getElementById(`pc-${side}-${first.replace(/\s/g,'_')}`);
      if (firstCard) firstCard.classList.remove('selected');
    }
    selectedXI[side].push(name);
    card.classList.add('selected');
  }
  updateXICount(side);
}

function updateXICount(side) {
  const n = selectedXI[side].length;
  const el = document.getElementById(`xi-count-${side}`);
  el.textContent = `${n} / 11`;
  el.className = 'xi-count ' + (n === 11 ? 'ok' : n > 0 ? 'partial' : 'empty');
}

function updateTossOptions() {
  const t1 = document.getElementById('m-team1').value;
  const t2 = document.getElementById('m-team2').value;
  const tossEl = document.getElementById('m-toss-winner');
  tossEl.innerHTML = '<option value="">Unknown</option>';
  [t1, t2].filter(Boolean).forEach(t => {
    tossEl.innerHTML += `<option value="${t}">${t}</option>`;
  });
}

function updateXIInfo() {
  const t1 = document.getElementById('m-team1').value;
  const t2 = document.getElementById('m-team2').value;
  document.getElementById('xi-info').style.display = (t1 || t2) ? 'block' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Match prediction
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function predictMatch() {
  const team1 = document.getElementById('m-team1').value;
  const team2 = document.getElementById('m-team2').value;
  const venue = document.getElementById('m-venue').value;
  if (!team1 || !team2 || !venue) { alert('Please fill Team 1, Team 2 and Venue'); return; }
  if (team1 === team2) { alert('Teams must be different'); return; }

  setLoading('m', true);
  try {
    const body = {
      team1, team2, venue,
      toss_winner: document.getElementById('m-toss-winner').value || null,
      toss_decision: document.getElementById('m-toss-decision').value || null,
    };
    if (selectedXI.team1.length === 11) body.team1_xi = selectedXI.team1;
    if (selectedXI.team2.length === 11) body.team2_xi = selectedXI.team2;

    const r = await fetch(`${API}/predict/match`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data.detail || r.statusText);
    showMatchResult(data);
  } catch(e) { showError('m', e.message); }
  setLoading('m', false);
}

function showMatchResult(d) {
  document.getElementById('m-t1-name').textContent = d.team1;
  document.getElementById('m-t2-name').textContent = d.team2;
  const p1 = (d.team1_win_probability * 100).toFixed(1);
  const p2 = (d.team2_win_probability * 100).toFixed(1);
  document.getElementById('m-t1-pct').textContent = p1 + '%';
  document.getElementById('m-t2-pct').textContent = p2 + '%';
  document.getElementById('m-t1-bar').style.width = p1 + '%';
  document.getElementById('m-t2-bar').style.width = p2 + '%';

  const conf = document.getElementById('m-conf');
  conf.textContent = d.confidence;
  conf.className = 'confidence conf-' + d.confidence;

  const xiBadge = document.getElementById('m-xi-badge');
  xiBadge.style.display = d.xi_used ? 'inline-block' : 'none';

  if (d.predicted_score_team1) {
    document.getElementById('m-score1').textContent = `Predicted: ~${d.predicted_score_team1} runs`;
    document.getElementById('m-score2').textContent = `Predicted: ~${d.predicted_score_team2} runs`;
  }

  const factorsEl = document.getElementById('m-factors');
  const factors = d.key_factors || [];
  factorsEl.innerHTML = factors.length
    ? '<div class="factors-title">Key Factors</div>' +
      factors.map(f => {
        const isPos = f.includes('(+');
        return `<div class="factor ${isPos?'pos':'neg'}"><span class="icon"></span><span>${f}</span></div>`;
      }).join('')
    : '';

  document.getElementById('m-result').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Score prediction
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function predictScore() {
  const batting = document.getElementById('s-batting').value;
  const bowling = document.getElementById('s-bowling').value;
  const venue   = document.getElementById('s-venue').value;
  if (!batting || !bowling || !venue) { alert('Please fill all fields'); return; }

  setLoading('s', true);
  try {
    const body = {
      batting_team: batting, bowling_team: bowling, venue,
      toss_winner:  document.getElementById('s-toss-winner').value || null,
      toss_decision: document.getElementById('s-toss-decision').value || null
    };
    const r = await fetch(`${API}/predict/score`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data.detail || r.statusText);
    document.getElementById('s-team-label').textContent = `${batting} batting at ${venue}`;
    document.getElementById('s-score').textContent = data.predicted_score;
    const margin = Math.round(data.score_range_high - data.predicted_score);
    document.getElementById('s-range').textContent = `Range: ${data.score_range_low}â€“${data.score_range_high} runs (Â±${margin})`;
    document.getElementById('s-venue-label').textContent = '';
    document.getElementById('s-result').classList.add('show');
  } catch(e) { showError('s', e.message); }
  setLoading('s', false);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Squad browser
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSquadBrowser() {
  const container = document.getElementById('squad-browser');
  const teams = Object.entries(allSquads);
  if (!teams.length) {
    container.innerHTML = '<span style="color:var(--muted)">No squad data available.</span>';
    return;
  }
  container.innerHTML = teams.map(([team, info]) => {
    const squad = info.squad || [];
    const playerRows = squad.map(p => {
      const injured = p.injury_status && p.injury_status !== 'fit';
      const roleShort = p.role === 'Batsman' ? 'BAT' : p.role === 'Bowler' ? 'BOWL' : 'AR';
      const roleCls = p.role === 'Batsman' ? 'role-bat' : p.role === 'Bowler' ? 'role-bowl' : 'role-all';
      return `<div class="squad-player-row" ${injured ? 'style="opacity:0.5"' : ''}>
        <div class="squad-player-name">${p.name}${p.is_captain ? ' <span style="color:var(--yellow)">â˜…</span>' : ''}${p.is_keeper ? ' <span style="color:var(--purple);font-size:0.7rem">WK</span>' : ''}</div>
        <div class="squad-player-meta">
          <span class="role-badge ${roleCls}">${roleShort}</span>
          ${injured ? `<span style="color:var(--red)">âš  ${p.injury_status}</span>` : ''}
        </div>
      </div>`;
    }).join('');
    return `<div class="squad-team-card">
      <div class="squad-team-name">${team}</div>
      <div class="squad-captain">Captain: ${info.captain || 'TBC'} Â· ${squad.length} players</div>
      ${playerRows}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Squad optimiser
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let squadPlayers = [];

function addPlayer(e) {
  if (e.key !== 'Enter') return;
  const input = document.getElementById('sq-player-input');
  const name  = input.value.trim();
  if (!name || squadPlayers.includes(name)) { input.value = ''; return; }
  squadPlayers.push(name);
  input.value = '';
  renderSquadOptim();
}

function removePlayer(name) {
  squadPlayers = squadPlayers.filter(p => p !== name);
  renderSquadOptim();
}

function renderSquadOptim() {
  const el = document.getElementById('sq-squad-list');
  el.innerHTML = squadPlayers.map(p =>
    `<div class="player-tag">${p}<span class="rm" onclick="removePlayer('${p.replace(/'/g,"\\'")}')">âœ•</span></div>`
  ).join('');
  document.getElementById('sq-count').textContent = `${squadPlayers.length} players added (need â‰¥11)`;
  document.getElementById('sq-btn').disabled = squadPlayers.length < 11;
}

async function optimiseSquad() {
  const team    = document.getElementById('sq-team').value.trim();
  const venue   = document.getElementById('sq-venue').value;
  const opponent= document.getElementById('sq-opponent').value.trim();
  if (!team || !venue) { alert('Fill team name and venue'); return; }
  if (squadPlayers.length < 11) { alert('Add at least 11 players'); return; }

  setLoading('sq', true);
  try {
    const body = { team, venue, squad: squadPlayers, opponent: opponent || null };
    const r = await fetch(`${API}/squad/optimise`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data.detail || r.statusText);
    document.getElementById('sq-xi').innerHTML = data.playing_xi.map(p =>
      `<span class="xi-chip">âœ“ ${p}</span>`).join('');
    document.getElementById('sq-bench').innerHTML = data.bench.map(p =>
      `<div class="player-tag" style="opacity:0.55">${p}</div>`).join('');
    document.getElementById('sq-reasoning').innerHTML = data.reasoning.length
      ? '<div style="font-size:0.82rem;color:var(--muted)">' +
        data.reasoning.map(r => `<div style="padding:0.2rem 0">â€¢ ${r}</div>`).join('') + '</div>'
      : '';
    if ((data.constraint_violations || []).length) {
      document.getElementById('sq-reasoning').innerHTML +=
        `<div style="color:var(--orange);font-size:0.78rem;margin-top:0.5rem">âš  ${data.constraint_violations.join(' Â· ')}</div>`;
    }
    document.getElementById('sq-result').classList.add('show');
  } catch(e) { showError('sq', e.message); }
  setLoading('sq', false);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Utilities
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name) {
  const tabNames = ['match','score','squads','optim'];
  document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', tabNames[i] === name));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
}

function setLoading(prefix, on) {
  document.getElementById(prefix + '-spinner').classList.toggle('show', on);
  document.getElementById(prefix + '-error').classList.remove('show');
}

function showError(prefix, msg) {
  const el = document.getElementById(prefix + '-error');
  el.textContent = 'âš  ' + msg;
  el.classList.add('show');
}

init();
</script>
</body>
</html>
